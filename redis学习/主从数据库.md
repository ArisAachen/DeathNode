## 架构

![global](../asset/redis_ms_global.png)


## 特点

1. 读写分离 
2. 宰容快速恢复 从服务器宕机 其他从服务器可以工作
3. 一主多从   由于主机用于写  多主机引起混乱 

## 原理
1. 从服务器连接主服务器  发送数据sync同步消息
2. 主服务器接到 sync, 进行rdb持久化, 再发送给从服务器  (全量复制)
3. 从服务器收到 rdb 后, 更新数据库   
4. 主服务器更新后 发送同步消息给从服务器  (增量复制)


## 步骤  
1. 创建 redis 文件夹  
2. 复制 redis.conf 到文件路径 
3. 配置一主两从的配置文件 即三个配置文件
4. 三个配置文件写入内容 
5. 执行命令 slaveof ip port

``` shell
// 查看关联关系
127.0.0.1:6379> info replication
# Replication
role:master
connected_slaves:0
master_replid:d882a5498d151015d2002b351fc16d842dbfe081
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0
```


``` shell
➜  Desktop mkdir /tmp/redis
➜  Desktop sudo cp /etc/redis/redis.conf /tmp/redis 
[sudo] aris 的密码： 
➜  Desktop cd /tmp/redis      
// vim redis master file      
➜  redis vim redis_master_6379.conf
include /tmp/redis/redis.conf
pidfile /tmp/redis/redis_master_6379.pid
port 6379
// 文件不能为路径, 可通过 dir 配置
dbfilename redis_master_6379.rdb

// 同样配置其他
```

``` shell 
// 启动 redis 后 
➜  redis ps -ef | grep redis
redis       7143       1  0 23:55 ?        00:00:00 /usr/bin/redis-server 127.0.0.1:6379
root        7336    1803  0 23:57 ?        00:00:00 redis-server 127.0.0.1:6380
root        7353    1803  0 23:57 ?        00:00:00 redis-server 127.0.0.1:6381
```

``` shell 
// 连接从机 6381
➜  Desktop redis-cli -p 6381

// 执行 slave 操作  6379 指定为637 没有报错
// 事实上此时并没有开启  而此时从机会等待
127.0.0.1:6381> slaveof 127.0.0.1 637
OK

// 查看 主从信息
127.0.0.1:6381> info replication
# Replication
role:slave
master_host:127.0.0.1
master_port:637
// 主机不在线
master_link_status:down
master_last_io_seconds_ago:-1
master_sync_in_progress:0
slave_repl_offset:0
master_link_down_since_seconds:1635436836
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:1d0e2c744e3f555cde58629d40eaad621573a5a0
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0
```

``` shell 
// 连接从机 6380
➜  Desktop redis-cli -p 6380

// 执行 slave 操作
127.0.0.1:6381> slaveof 127.0.0.1 6379
OK

// 查看 主从信息
127.0.0.1:6380> info replication
# Replication
role:slave
master_host:127.0.0.1
master_port:6379
master_link_status:up
master_last_io_seconds_ago:10
master_sync_in_progress:0
slave_repl_offset:364
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:8fc4d3276f6d006f907640c5fcc14f162847c859
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:364
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:364
```

``` shell
// 连接主机 6379
➜  Desktop redis-cli -p 6379

// 查看主机信息
127.0.0.1:6379> info replication
# Replication
role:master
connected_slaves:2
// 从服务器 online
slave0:ip=127.0.0.1,port=6380,state=online,offset=630,lag=0
slave1:ip=127.0.0.1,port=6381,state=online,offset=630,lag=1
master_replid:8fc4d3276f6d006f907640c5fcc14f162847c859
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:630
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:630
```

## 读写

``` shell 
// 读取从机
127.0.0.1:6380> keys *
(empty list or set)
127.0.0.1:6380> 
```

``` shell 
// 主机写入
127.0.0.1:6379> set k1 aris
OK

// 从机读取
127.0.0.1:6380> get k1
"aris"
```

``` shell
// 从机写入报错 
127.0.0.1:6380> set k2 uos
(error) READONLY You can't write against a read only replica. 
```


